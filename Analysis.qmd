---
title: "AnalysisTEASalaries"
format: html
---

## Setup

```{r}
#| label: setup

library(tidyverse)
library(janitor)

```

## Read in cleaned data

```{r}
teaching_staff_salaries <- read_rds("data-processed/teaching_staff_salaries.rds")
cpi <- read_rds("data-processed/cpi_201401_202502")
household_budget <- read_rds("data-processed/alice_household_budget.rds")
```



Now I want to only look at totals for teaching staff at each district. 

```{r}
teaching_staff_totals <- teaching_staff_salaries |> filter(staff == "TOTAL TEACHING STAFF")

teaching_staff_totals
```

Now let's make this graphable. 

```{r}
teaching_staff_average_school_years <- teaching_staff_totals |>
  group_by(district_name.x, school_year) |> summarize(avg_pay = mean(average_base_pay))

teaching_staff_average_school_years
```

Okay there's too many schools for us to graph these all at once. Maybe if we just do one region (central texas, 13).

```{r}
austin_schools <- teaching_staff_totals |> filter(region == "13") |> 
  group_by(district_name.x, school_year) |> summarize(avg_pay = mean(average_base_pay))

austin_schools
```

That's still too many to be understandable on a graph. Let's instead look at just one district. 

```{r}
austin <- austin_schools |> filter(district_name.x == "AUSTIN ISD")
```


```{r}
ggplot(austin, aes(x = school_year, y = avg_pay, color = district_name.x, group = district_name.x)) +
  geom_line() + 
  theme(legend.position = "none") #+
  #facet_wrap(~district_name)    # we can use this is we are looking at multiple districts
```

```{r}
ggplot(cpi, aes(x = year_month, y = cpi)) +
  geom_line()
```

## With District Types

I want to see how many district types there are for TEA definition. 

```{r}
teaching_staff_totals |> group_by(tea_description) |> count()
```

I see that there is "N/A" and NA values. Let's combine those into one category. 

```{r}
teaching_staff_totals <- teaching_staff_totals |> mutate(
  tea_description = tea_description |> na_if ("N/A")
)
```

Now I want to see the average pay for each TEA district type for each school year. 

```{r}
district_types_tea_chart <- teaching_staff_totals |> group_by(tea_description, school_year) |> 
  summarize(avg_pay = mean(average_base_pay))

district_types_tea_chart
```

Now let's chart it. 

```{r}
ggplot(district_types_tea_chart, aes(x = school_year, y = avg_pay, color = tea_description, group = tea_description)) +
  geom_point() +
  geom_line() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 4, byrow = TRUE))
```

OKay I am going to repeat the same process I just did but for the NCES district type definitions. 

```{r}
teaching_staff_totals |> group_by(nces_description) |> count()
```

Finding average pay per school year for each NCES district type.

```{r}
district_types_nces_chart <- teaching_staff_totals |> group_by(nces_description, school_year) |> 
  summarize(avg_pay = mean(average_base_pay))

district_types_nces_chart
```

Graphing it. 

```{r}
ggplot(district_types_nces_chart, aes(x = school_year, y = avg_pay, color = nces_description, group = nces_description)) +
  geom_point() +
  geom_line() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(nrow = 4, byrow = TRUE))
```

## Adding Cost of Living

Now that we have ALICE's household survival budget, I can use it to compare that to each districts salaries. 

First, I am going to clean up the alice data so I can join it with my salary data.

```{r}

household_budget_simple <- household_budget |> 
  mutate(county = paste(toupper(county), "COUNTY"),
         end_year = as.character(year)) |> 
  select(end_year, county, alice_threshold_hh_under_65)

household_budget_simple
```

Now, I am going to left join it on both the county and year. 

```{r}
salaries_col <- teaching_staff_totals |> left_join(household_budget_simple, by = c("county", "end_year"))

salaries_col
```

There are a few years that are inconsistent between the datasets. But since I have data around each year, I can use that. For example, I want to use 2016 for 2015 when needed. But, I also want to use 2022 for 2024 when needed. So I am going to fill up first, then down in each county. First, I tested it out with a single district. 

```{r}
testing_filling <- salaries_col |> filter(county == "ANDERSON COUNTY") |> select(
  county, district_name.x, school_year, end_year, alice_threshold_hh_under_65) |> 
  fill(alice_threshold_hh_under_65, .direction = "updown")


testing_filling
```

Now, I'll do it for all of the data. 

```{r}
salaries_col_fill <- salaries_col |> arrange(county, end_year) |> 
  group_by(county) |> 
  fill(alice_threshold_hh_under_65, .direction = "updown")

salaries_col_fill
```

Now I want to see the difference between the ALICE budget and the average salary for each district. 

```{r}
salary_col_comparison <- salaries_col_fill |> mutate(
  difference = alice_threshold_hh_under_65 - average_base_pay
) |> select(
  region, county, district_name.x, average_base_pay, school_year, end_year, tea_district_type, tea_description, nces_district_type, nces_description, alice_threshold_hh_under_65, difference
)

salary_col_comparison
```







